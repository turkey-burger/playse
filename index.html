<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>playse</title>

  <style>
    /*
      UI pass (matches Figma exports) + Figma-exported SVG icons from /icons

      Required repo paths:
      - /fonts/ABCDiatypeMono-Light-Trial.woff2
      - /icons/Play_Desktop.svg
      - /icons/Play_Mobile.svg
      - /icons/Pause_Desktop.svg
      - /icons/Pause Mobile.svg   (space is OK; referenced as Pause%20Mobile.svg)
      - /icons/Spotify_Desktop.svg
      - /icons/Spotify_Mobile.svg
      - /icons/Apple_Music_Desktop.svg
      - /icons/Apple_Music_Mobile.svg
    */

    @font-face {
      font-family: "ABCDiatypeMono";
      src: url("./fonts/ABCDiatypeMono-Light-Trial.woff2") format("woff2");
      font-weight: 300;
      font-style: normal;
      font-display: swap;
    }

    :root {
      --bg-top: #9aa0a7;
      --bg-mid: #6f7a83;
      --bg-bot: #4b5a66;

      --fg: #ffffff;
      --fg-dim: rgba(255,255,255,0.55);

      --pad-desktop: 64px;
      --pad-mobile: 56px;

      --logo-size-desktop: 44px;
      --logo-size-mobile: 72px;
      --logo-tracking-desktop: 0.55em;
      --logo-tracking-mobile: 0.28em;

      --btn-size-desktop: 30px;
      --btn-size-mobile: 88px;

      --title-size-desktop: 20px;
      --artist-size-desktop: 20px;
      --title-size-mobile: 26px;
      --artist-size-mobile: 22px;

      --library-label-size-desktop: 20px;
      --library-label-size-mobile: 28px;
      
      --service-icon-height-desktop: 24px;
      --service-icon-height-mobile: 24px;
      --service-gap-desktop: 64px;
      --service-gap-mobile: 40px;

      --toast-bg: rgba(255,255,255,0.14);
      --toast-border: rgba(255,255,255,0.28);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      color: var(--fg);
      font-family: "ABCDiatypeMono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-weight: 300;
      background: linear-gradient(180deg, var(--bg-top) 0%, var(--bg-mid) 55%, var(--bg-bot) 100%);
      overflow: hidden;
    }

    .noselect {
      -webkit-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .screen {
      min-height: 100vh;
      width: 100vw;
      display: grid;
      grid-template-rows: auto 1fr auto;
      padding: var(--pad-desktop);
    }

    .hidden { display: none !important; }

    .top {
      display: flex;
      align-items: flex-start;
      justify-content: center;
    }

    .logo {
      font-size: var(--logo-size-desktop);
      letter-spacing: var(--logo-tracking-desktop);
      line-height: 1;
      text-transform: lowercase;
    }

    .center {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 40px;
    }

    .icon-btn {
      appearance: none;
      border: none;
      background: transparent;
      width: var(--btn-size-desktop);
      height: var(--btn-size-desktop);
      padding: 0;
      cursor: pointer;
      display: grid;
      place-items: center;
      color: var(--fg);
    }

    .icon-btn:active { transform: scale(0.98); }

    .icon-img {
      display: block;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .track {
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .track .title {
      font-size: var(--title-size-desktop);
      letter-spacing: 0.08em;
      line-height: 1.2;
    }

    .track .artist {
      font-size: var(--artist-size-desktop);
      letter-spacing: 0.06em;
      color: var(--fg-dim);
      line-height: 1.2;
    }

    .bottom {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      gap: 18px;
      padding-bottom: 24px;
    }

    .library-label {
      font-size: var(--library-label-size-desktop);
      letter-spacing: 0.12em;
      text-transform: lowercase;
    }

    .services {
      display: flex;
      align-items: center;
      gap: 64px;
    }

    .service-link {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--fg);
      text-decoration: none;
      opacity: 1;
    }

    .service-link.disabled { opacity: 0.4; }

    .service-icon-img {
      display: block;
      width: auto;
      height: auto;
      object-fit: contain;
    }

    /* Loading dots */
    .dots {
      display: inline-flex;
      gap: 22px;
      align-items: center;
      justify-content: center;
      height: var(--btn-size-desktop);
    }

    .dot {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: var(--fg);
      opacity: 0.95;
      animation: bounce 900ms infinite ease-in-out;
    }

    .dot:nth-child(2) { animation-delay: 120ms; }
    .dot:nth-child(3) { animation-delay: 240ms; }

    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); opacity: 0.9; }
      40% { transform: translateY(-10px); opacity: 1; }
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 22px;
      transform: translateX(-50%);
      max-width: min(560px, calc(100vw - 24px));
      padding: 12px 14px;
      border: 1px solid var(--toast-border);
      background: var(--toast-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: var(--fg);
      font-size: 14px;
      letter-spacing: 0.02em;
      line-height: 1.35;
      border-radius: 999px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 160ms ease;
      text-align: center;
    }

    .toast.show { opacity: 1; }

    /* Mobile */
    @media (max-width: 520px) {
  /* iPhone 15 Figma reference height ~852px */
  :root {
    --y-logo: 8.215vh;     /* 70 / 852 */
    --y-btn: 47.183vh;     /* 402 / 852 */
    --y-track: 59.0vh;   /* 478 / 852 */
    --y-bottom: 80.164vh;  /* 683 / 852 */
  }

  @supports (height: 1svh) {
    :root {
      --y-logo: 8.215svh;
      --y-btn: 47.183svh;
      --y-track: 59.0svh;
      --y-bottom: 80.164svh;
    }
  }

  :root {
    --btn-size-desktop: var(--btn-size-mobile);
    --service-icon-height-desktop: var(--service-icon-height-mobile);
    --service-gap-desktop: var(--service-gap-mobile);
  }

  /* Make each state screen the positioning context */
  #state-landing,
  #state-loading,
  #state-player {
    padding: 0;
    position: relative;
    min-height: 100vh;
  }

  /* Center the logo on mobile (all states) */
  #state-landing .top,
  #state-loading .top,
  #state-player .top {
    position: absolute;
    left: 50%;
    top: calc(env(safe-area-inset-top) + var(--y-logo));
    transform: translateX(-50%);
    width: 100%;
    display: flex;
    justify-content: center;
    pointer-events: none;
  }

  #state-landing .logo,
  #state-loading .logo,
  #state-player .logo {
    font-size: 40px;
    line-height: 56px;
    letter-spacing: 0.4em; /* Figma 40% */
    white-space: nowrap;
  }

  /* LANDING: play button position */
  #state-landing #playBtn {
    position: absolute;
    left: 50%;
    top: calc(env(safe-area-inset-top) + var(--y-btn));
    transform: translateX(-50%);
    width: 45px;
    height: 48px;
    padding: 0;
  }

  /* LOADING: dots position */
  #state-loading .dots {
    position: absolute;
    left: 50%;
    top: calc(env(safe-area-inset-top) + var(--y-btn));
    transform: translateX(-50%);
  }

  /* PLAYER: pause/play button position */
  #state-player #toggleBtn {
    position: absolute;
    left: 50%;
    top: calc(env(safe-area-inset-top) + var(--y-btn));
    transform: translateX(-50%);
    width: 45px;
    height: 48px;
    padding: 0;
  }

  /* PLAYER: track title + artist position (relative to screen, not .center) */
  #state-player .track {
    position: absolute;
    left: 50%;
    top: calc(env(safe-area-inset-top) + var(--y-track));
    transform: translateX(-50%);
    width: min(92vw, 360px);
    text-align: center;
    display: flex;
    flex-direction: column;
    gap: 10px; /* title -> artist */
  }

  #state-player .track .title {
    font-size: 16px;
    line-height: 20px;
    letter-spacing: 0;
  }

  #state-player .track .artist {
    font-size: 16px;
    line-height: 20px;
    letter-spacing: 0;
    color: #b2b2b2;
  }

  /* PLAYER: Add to library + service icons block */
  #state-player .bottom {
    position: absolute;
    left: 50%;
    top: calc(env(safe-area-inset-top) + var(--y-bottom));
    transform: translateX(-50%);
    width: min(92vw, 360px);
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 18px;
  }

  #state-player .library-label {
    font-size: 16px;
    line-height: 20px;
    letter-spacing: 0;
    text-transform: lowercase;
    text-align: center;
  }

  #state-player .services {
    display: flex;
    justify-content: center;
    gap: 40px;
  }

  #state-player .service-icon-img {
    width: 114px;
    height: 42px;
    object-fit: contain;
  }

  /* Keep toast above iOS home indicator */
  .toast {
    bottom: calc(22px + env(safe-area-inset-bottom));
  }
}

@media (min-width: 521px) {
  .center {
    gap: 40px;
  }
}



    
  </style>
</head>

<body class="noselect">
  <!-- LANDING -->
  <div id="state-landing" class="screen">
    <div class="top"><div class="logo" aria-label="playse">playse</div></div>
    <div class="center">
      <button class="icon-btn" id="playBtn" aria-label="Play">
        <picture>
          <source media="(max-width: 520px)" srcset="./icons/Play_Mobile.svg">
          <img class="icon-img" src="./icons/Play_Desktop.svg" alt="" aria-hidden="true">
        </picture>
      </button>
    </div>
    <div class="bottom"></div>
  </div>

  <!-- LOADING -->
  <div id="state-loading" class="screen hidden">
    <div class="top"><div class="logo" aria-label="playse">playse</div></div>
    <div class="center" aria-label="Loading">
      <div class="dots" aria-hidden="true">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
    </div>
    <div class="bottom"></div>
  </div>

  <!-- PLAYER -->
  <div id="state-player" class="screen hidden">
    <div class="top"><div class="logo" aria-label="playse">playse</div></div>

    <div class="center">
      <button class="icon-btn" id="toggleBtn" aria-label="Pause">
        <picture id="pauseIcon" aria-hidden="true">
          <source media="(max-width: 520px)" srcset="./icons/Pause_Mobile.svg">
          <img class="icon-img" src="./icons/Pause_Desktop.svg" alt="">
        </picture>
        <picture id="playIcon" class="hidden" aria-hidden="true">
          <source media="(max-width: 520px)" srcset="./icons/Play_Mobile.svg">
          <img class="icon-img" src="./icons/Play_Desktop.svg" alt="">
        </picture>
      </button>

      <div class="track" aria-live="polite" aria-atomic="true">
        <div class="title" id="trackTitle">—</div>
        <div class="artist" id="trackArtist">—</div>
      </div>
    </div>

    <div class="bottom">
      <div class="library-label">Add to Library</div>
      <div class="services">
        <a id="spotifyLink" class="service-link" href="#" target="_blank" rel="noopener" aria-label="Add to Spotify">
          <picture>
            <source media="(max-width: 520px)" srcset="./icons/Spotify_Mobile.svg">
            <img class="service-icon-img" src="./icons/Spotify_Desktop.svg" alt="" aria-hidden="true">
          </picture>
        </a>

        <a id="appleLink" class="service-link" href="#" target="_blank" rel="noopener" aria-label="Add to Apple Music">
          <picture>
            <source media="(max-width: 520px)" srcset="./icons/Apple_Music_Mobile.svg">
            <img class="service-icon-img" src="./icons/Apple_Music_Desktop.svg" alt="" aria-hidden="true">
          </picture>
        </a>
      </div>
    </div>

    <audio id="audio" preload="metadata"></audio>
  </div>

  <div class="toast" id="toast" aria-live="polite" aria-atomic="true"></div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const AUDIO_BASE = 'https://pub-711bcf5604184f5580b7ad5cf4df3511.r2.dev';
      const sections = [
        { audio: `${AUDIO_BASE}/playse_1.mp3`, tracklist: 'playse_1_tracklist.csv' },
        { audio: `${AUDIO_BASE}/playse_2.mp3`, tracklist: 'playse_2_tracklist.csv' },
        { audio: `${AUDIO_BASE}/playse_3.mp3`, tracklist: 'playse_3_tracklist.csv' },
        { audio: `${AUDIO_BASE}/playse_4.mp3`, tracklist: 'playse_4_tracklist.csv' },
        { audio: `${AUDIO_BASE}/playse_5.mp3`, tracklist: 'playse_5_tracklist.csv' },
        { audio: `${AUDIO_BASE}/playse_6.mp3`, tracklist: 'playse_6_tracklist.csv' },
        { audio: `${AUDIO_BASE}/playse_7.mp3`, tracklist: 'playse_7_tracklist.csv' },
        { audio: `${AUDIO_BASE}/playse_8.mp3`, tracklist: 'playse_8_tracklist.csv' },
        { audio: `${AUDIO_BASE}/playse_9.mp3`, tracklist: 'playse_9_tracklist.csv' },
        { audio: `${AUDIO_BASE}/playse_10.mp3`, tracklist: 'playse_10_tracklist.csv' },
        { audio: `${AUDIO_BASE}/playse_11.mp3`, tracklist: 'playse_11_tracklist.csv' },
        { audio: `${AUDIO_BASE}/playse_12.mp3`, tracklist: 'playse_12_tracklist.csv' },
        { audio: `${AUDIO_BASE}/playse_13.mp3`, tracklist: 'playse_13_tracklist.csv' },
        { audio: `${AUDIO_BASE}/playse_14.mp3`, tracklist: 'playse_14_tracklist.csv' },
        { audio: `${AUDIO_BASE}/playse_15.mp3`, tracklist: 'playse_15_tracklist.csv' },
        { audio: `${AUDIO_BASE}/playse_16.mp3`, tracklist: 'playse_16_tracklist.csv' },
        { audio: `${AUDIO_BASE}/playse_17.mp3`, tracklist: 'playse_17_tracklist.csv' },
        { audio: `${AUDIO_BASE}/playse_18.mp3`, tracklist: 'playse_18_tracklist.csv' },
        
      ];

      const NOT_AVAILABLE_MSG = "Sorry, this song isn't available on the selected streaming service";

      const audio = document.getElementById('audio');

      const landing = document.getElementById('state-landing');
      const loading = document.getElementById('state-loading');
      const player = document.getElementById('state-player');

      const playBtn = document.getElementById('playBtn');
      const toggleBtn = document.getElementById('toggleBtn');

      const playIcon = document.getElementById('playIcon');
      const pauseIcon = document.getElementById('pauseIcon');

      const trackTitle = document.getElementById('trackTitle');
      const trackArtist = document.getElementById('trackArtist');
      const spotifyLink = document.getElementById('spotifyLink');
      const appleLink = document.getElementById('appleLink');

      const toast = document.getElementById('toast');

      let started = false;
      let currentSectionIndex = 0;
      let tracks = [];
      let currentTrackIndex = -1;
      let toastTimer = null;

      function showLanding() {
        landing.classList.remove('hidden');
        loading.classList.add('hidden');
        player.classList.add('hidden');
      }

      function showLoading() {
        landing.classList.add('hidden');
        loading.classList.remove('hidden');
        player.classList.add('hidden');
      }

      function showPlayer() {
        landing.classList.add('hidden');
        loading.classList.add('hidden');
        player.classList.remove('hidden');
      }

      function showToast(message) {
        toast.textContent = message;
        toast.classList.add('show');
        if (toastTimer) clearTimeout(toastTimer);
        toastTimer = setTimeout(() => toast.classList.remove('show'), 2400);
      }

      function setLink(el, url) {
        const has = !!(url && String(url).trim());
        if (has) {
          el.href = url;
          el.classList.remove('disabled');
          el.setAttribute('aria-disabled', 'false');
        } else {
          el.href = '#';
          el.classList.add('disabled');
          el.setAttribute('aria-disabled', 'true');
        }
      }

      function attachUnavailableHandler(el) {
        el.addEventListener('click', (e) => {
          const href = el.getAttribute('href');
          if (!href || href === '#') {
            e.preventDefault();
            showToast(NOT_AVAILABLE_MSG);
          }
        });
      }

      attachUnavailableHandler(spotifyLink);
      attachUnavailableHandler(appleLink);

      function updateTrackUI(track) {
        trackTitle.textContent = track?.title?.trim() || '—';
        trackArtist.textContent = track?.artist?.trim() || '—';
        setLink(spotifyLink, track?.spotify_url || '');
        setLink(appleLink, track?.apple_music_url || '');
      }

      function setPausedUI(isPaused) {
        if (isPaused) {
          pauseIcon.classList.add('hidden');
          playIcon.classList.remove('hidden');
          toggleBtn.setAttribute('aria-label', 'Play');
        } else {
          playIcon.classList.add('hidden');
          pauseIcon.classList.remove('hidden');
          toggleBtn.setAttribute('aria-label', 'Pause');
        }
      }

      function hmsToSeconds(hms) {
        const parts = String(hms || '').trim().split(':').map(Number);
        if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
        if (parts.length === 2) return parts[0] * 60 + parts[1];
        return 0;
      }

      function normalizeHeader(s) {
        return String(s || '').trim().toLowerCase();
      }

      function getField(row, candidates) {
        const keys = Object.keys(row || {});
        const normalized = new Map(keys.map(k => [normalizeHeader(k), k]));
        for (const c of candidates) {
          const hit = normalized.get(normalizeHeader(c));
          if (hit != null) return row[hit];
        }
        return '';
      }

      async function loadTracklistForSection(index) {
        const url = sections[index].tracklist;
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error(`Tracklist fetch failed (${res.status}): ${url}`);

        const text = await res.text();
        const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });

        tracks = (parsed.data || [])
          .map(row => {
            const time = getField(row, ['start_time','time','timestamp','Time']);
            const title = getField(row, ['title','track title','Track Title','song','song title']);
            const artist = getField(row, ['artist','artist name','Artist Name','artists','artist(s)']);
            const spotify = getField(row, ['spotify_url','spotify url','Spotify URL','spotify','spotify link']);
            const apple = getField(row, ['apple_music_url','apple url','Apple URL','apple','apple music','apple link']);

            return {
              start: hmsToSeconds(time),
              title: String(title || '').trim(),
              artist: String(artist || '').trim(),
              spotify_url: String(spotify || '').trim(),
              apple_music_url: String(apple || '').trim(),
            };
          })
          .filter(t => t.title || t.artist)
          .sort((a, b) => a.start - b.start);

        currentTrackIndex = -1;
      }

      function findTrackIndex(seconds) {
        for (let i = tracks.length - 1; i >= 0; i--) {
          if (seconds >= tracks[i].start) return i;
        }
        return tracks.length ? 0 : -1;
      }

      async function setSection(index, { startAtSeconds = 0, autoplay = false } = {}) {
        currentSectionIndex = index;
        currentTrackIndex = -1;

        await loadTracklistForSection(index);

        audio.src = sections[index].audio;
        audio.load();

        await new Promise(resolve => {
          const onMeta = () => {
            audio.removeEventListener('loadedmetadata', onMeta);
            resolve();
          };
          audio.addEventListener('loadedmetadata', onMeta);
        });

        const safeStart = Math.max(0, Math.min(startAtSeconds, Math.max(0, audio.duration - 0.25)));
        audio.currentTime = safeStart;

        const idx = findTrackIndex(audio.currentTime);
        if (idx >= 0) {
          currentTrackIndex = idx;
          updateTrackUI(tracks[idx]);
        } else {
          updateTrackUI(null);
        }

        if (autoplay) await audio.play();
      }

      async function startRandomFirstPlay() {
        showLoading();

        const idx = Math.floor(Math.random() * sections.length);
        await setSection(idx, { startAtSeconds: 0, autoplay: false });

        await audio.play();

        const buffer = 2;
        const max = Math.max(0, audio.duration - buffer);
        audio.currentTime = Math.random() * max;

        const ti = findTrackIndex(audio.currentTime);
        if (ti >= 0) {
          currentTrackIndex = ti;
          updateTrackUI(tracks[ti]);
        }

        started = true;
      }

      playBtn.addEventListener('click', async () => {
        try {
          if (!started) {
            await startRandomFirstPlay();
          } else {
            await audio.play();
          }
        } catch (err) {
          console.error(err);
          showToast('Playback failed. Try again.');
          showLanding();
        }
      });

      toggleBtn.addEventListener('click', async () => {
        try {
          if (audio.paused) await audio.play();
          else audio.pause();
        } catch (err) {
          console.error(err);
          showToast('Playback failed. Try again.');
        }
      });

      audio.addEventListener('play', () => {
        setPausedUI(false);
        showPlayer();
      });

      audio.addEventListener('pause', () => {
        setPausedUI(true);
      });

      audio.addEventListener('timeupdate', () => {
        if (!tracks.length) return;
        const idx = findTrackIndex(audio.currentTime);
        if (idx !== currentTrackIndex && idx >= 0) {
          currentTrackIndex = idx;
          updateTrackUI(tracks[idx]);
        }
      });

      audio.addEventListener('ended', async () => {
        try {
          const next = (currentSectionIndex + 1) % sections.length;
          await setSection(next, { startAtSeconds: 0, autoplay: true });
        } catch (err) {
          console.error(err);
          showToast('Could not load the next section.');
        }
      });

      showLanding();
      updateTrackUI(null);
      setLink(spotifyLink, '');
      setLink(appleLink, '');
      setPausedUI(true);
    });
  </script>
</body>
</html>
